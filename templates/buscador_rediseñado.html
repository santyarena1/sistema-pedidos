<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Comparador de Precios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    body {
      background: #fdf5f5;
      font-family: 'Segoe UI', sans-serif;
    }
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 240px;
      background-color: #1c1c1c;
      color: white;
      padding: 2rem 1rem;
      z-index: 100;
    }
    #main-content {
      margin-left: 240px;
      padding: 2rem;
    }
    .sidebar-title {
      font-size: 1.4rem;
      margin-bottom: 2rem;
    }
    .nav-link {
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nav-link:hover {
      color: #ffc107 !important;
    }
    .btn-red {
      background-color: #c0392b;
      color: white;
    }
    .btn-red:hover {
      background-color: #a93226;
    }
    .card-search {
      background: white;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #b30000;
      font-weight: bold;
    }
    .table thead {
      background-color: #b30000;
      color: white;
    }
    .table tbody tr:hover {
      background-color: #f9e6e6;
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div class="sidebar-title"><i class="fas fa-cubes"></i> TheGamerShop</div>
  <ul class="nav flex-column">
    <li class="nav-item mb-2"><a class="nav-link text-white" href="/presupuestos"><i class="fas fa-file-invoice-dollar"></i> Presupuestos</a></li>
    <li class="nav-item mb-2"><a class="nav-link text-white" href="/buscar"><i class="fas fa-search"></i> Comparador</a></li>
    <li class="nav-item mb-2"><a class="nav-link text-white" href="/carrito"><i class="fas fa-shopping-cart"></i> Carrito</a></li>
    <li class="nav-item mb-2"><a class="nav-link text-white" href="pc_armadas"><i class="fas fa-desktop"></i> PC Armadas</a></li>
    <li class="nav-item mb-2"><a class="nav-link text-white" href="/pedidos"><i class="fas fa-truck"></i> Pedidos</a></li>
    <li class="nav-item mb-2"><a class="nav-link text-white" href="/pedidos/lista"><i class="fas fa-list"></i> Lista de Pedidos</a></li>
  </ul>
</div>

<!-- Contenido -->
<div id="main-content">
  <h1 class="text-center"><i class="fas fa-tags"></i> Comparador de Precios en Vivo</h1>

  <div class="card-search my-4 mx-auto" style="max-width: 800px;">
    <div class="d-flex">
      <input type="text" id="producto" class="form-control me-2" placeholder="Ej: Ryzen 5600G">
      <button class="btn btn-red me-2" onclick="buscar()">Buscar</button>
      <button class="btn btn-outline-dark me-2" onclick="window.location.href='carrito_redise√±ado.html'">Ver Carrito</button>
      <button class="btn btn-outline-secondary" onclick="window.location.href='presupuesto_redise√±ado.html'">Crear Presupuesto</button>
    </div>
  </div>

  <div class="d-flex justify-content-end mb-3">
    <select id="ordenSelect" class="form-select w-auto">
      <option value="precio_asc">Menor precio</option>
      <option value="precio_desc">Mayor precio</option>
      <option value="nombre_asc">A-Z</option>
      <option value="nombre_desc">Z-A</option>
    </select>
  </div>

  <div id="tabla" class="mt-4"></div>
</div>

<script>
  document.getElementById("ordenSelect").addEventListener("change", buscar);

  async function buscar() {
    const prod = document.getElementById("producto").value.trim();
    if (!prod) return;
    const tablaDiv = document.getElementById("tabla");
    tablaDiv.innerHTML = "<p class='text-muted'>üîÑ Buscando en tiendas...</p>";

    try {
      const res = await fetch(` /comparar?producto=${encodeURIComponent(prod)}`);
      const data = await res.json();

      // ‚úÖ Asegurarse de tener precio_num num√©rico para todos
      data.forEach(item => {
        item.precio_num = parseFloat(String(item.precio || "").replace("$", "").replace(/\./g, "").replace(",", ".")) || 0;
      });

      // üîΩ Ordenamiento
      const orden = document.getElementById("ordenSelect").value;
      if (orden === "precio_asc") {
        data.sort((a, b) => a.precio_num - b.precio_num);
      } else if (orden === "precio_desc") {
        data.sort((a, b) => b.precio_num - a.precio_num);
      } else if (orden === "nombre_asc") {
        data.sort((a, b) => a.producto.localeCompare(b.producto));
      } else if (orden === "nombre_desc") {
        data.sort((a, b) => b.producto.localeCompare(a.producto));
      }

      if (data.error) {
        tablaDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        return;
      }

      let html = `<h4>Resultados para: <span class="text-danger">${prod}</span></h4>`;
      html += `<table class="table table-bordered mt-3"><thead><tr><th>Sitio</th><th>Producto</th><th>Precio</th><th>Link</th><th>Agregar</th></tr></thead><tbody>`;
      data.forEach(item => {
        html += `<tr>
          <td>${item.sitio}</td>
          <td>${item.producto || "N/A"}</td>
          <td>${item.precio || "N/A"}</td>
          <td><a href="${item.link}" target="_blank" class="btn btn-sm btn-outline-secondary">Ver</a></td>
          <td><button class="btn btn-sm btn-red" onclick='agregarAlCarrito(${JSON.stringify(item)})'><i class="fas fa-cart-plus"></i></button></td>
        </tr>`;
      });
      html += "</tbody></table>";
      tablaDiv.innerHTML = html;

    } catch (err) {
      tablaDiv.innerHTML = `<div class="alert alert-warning">‚ùå Error de conexi√≥n: ${err.message}</div>`;
    }
  }

  async function agregarAlCarrito(item) {
    const precioLimpio = parseFloat(
      String(item.precio || "")
        .replace("$", "")
        .replace(/\./g, "")
        .replace(",", ".")
    );

    const body = {
      sitio: item.sitio || "Desconocido",
      producto: item.producto || "Sin nombre",
      precio: isNaN(precioLimpio) ? 0 : precioLimpio,
      link: item.link || "#"
    };

    const res = await fetch(" /carrito", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      alert("‚úÖ Producto agregado al carrito");
    } else {
      const data = await res.json();
      alert("‚ùå Error: " + (data?.error || "No se pudo agregar"));
    }
  }
</script>
</body>
</html>
